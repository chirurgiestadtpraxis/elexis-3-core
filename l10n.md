# Localisation / translation

For a background see http://www.vogella.com/tutorials/EclipseInternationalization and consider that most Elexis plugins are still Eclips 3 based.

We use "Trema":http://netceteragroup.github.io/trema-eclipse/. It is comprised of an Eclipse-Plugin, which has a nice editor for the texts.trm file placed at the root of
each project which has messages to be translated into different languages. The "Trema maven plugin":http://netceteragroup.github.io/trema-maven/ creates messages_<lang>.properties
files in an early build phase.

With the Tream plugin each save action updates the messages*.properties files specified in the pom.xml. But no new constants are added to the Messages.java file. This must be done manually.

For finding the name of the localized string (e.g. in a dialog), it is helpful to activate the line @<filter>addkeytovalue</filter>@ (see "pom.xml":ch.elexis.core.ui/pom.xml).
After rebuilding each localized string gets the name of the key appended.

## New tool Trema

The branch https://github.com/ngiger/elexis-3-core/tree/i18n was used in the first quarter of 2017 to explore the possibilities to create an italian translation.

We use "Trema":http://netceteragroup.github.io/trema-eclipse/. It is comprised of an Eclipse-Plugin, which has a nice editor for the texts.trm file placed at the root of each project which has messages to be translated into different languages. The "Trema maven plugin":http://netceteragroup.github.io/trema-maven/ creates messages_<lang>.properties files in an early build phase.

With the Tream plugin each save action updates the messages*.properties files specified in the pom.xml. But no new constants are added to the Messages.java file. This must be done manually.

For finding the name of the localized string (e.g. in a dialog), it is helpful to activate the line @<filter>addkeytovalue</filter>@ (see "pom.xml":ch.elexis.core.ui/pom.xml).
After rebuilding each localized string gets the name of the key appended.

As of december 2017 I am unsure whether, we really should use Trema or not. As I decided to move all message to a new plugin ch.elexis.core.l10n and  maybe it will be easier for other developers to use the *properties files.

## Why we place everything into one file

* When starting up we see clearly which messages or used or missing.
* Using constants in Messages.java make searching for occurrences much easier
* It is easier to detect/correct spelling differences/replacing one word by another

## Task list for Elexis 3.5 french translation

### Howto migrate a single Messages.java

* Add a dependency (if needed) to ch.elexis.core.l10n in the MANIFEST.MF
* Files which do contain "public static String" declaration should be converted to

    package ch.elexis.core.ui;
    public class Messages  {
    };

** Building the project will fail, and for each failure you must add a string like "public static final String LoginDialog_loginHeader = ch.elexis.core.l10n.Messages.LoginDialog_loginHeader;"

* Else open the file
** copy all String xy = ; to ch.elexis.core.l10n.Messages.java
** Remove "import org.eclipse.osgi.util.NLS;" and its uses
** replace all strings "String (.*);" using a regular expressiong wiht "String \1 = ch.elexis.core.l10n.Messages.\1;"
** Remove line containing "BUNDLE_NAME"
** Remove the message*.properties files
** Sort the string constants in ch.elexis.core.l10n.Messages.java

### Task order
I imagine the following order

* Convert the 37 (of 162 Messages.java file elexis (core, base,gpl)) which have still the old format to the new format, eg.
  ch.elexis.core.data.util/Messages.java which extend org.eclipse.osgi.util.NLS or import java.util.ResourceBundle
* Wait till elexis-3-core/base are converted to the pomless tycho build (as this will move all java files into another subdirectory)
* for each plugin/feature create one Messages.java which extends the symbolic name of the plugin, eg.
  the plugin ch.elexis.core.documents must have exactly one ch.elexis.core.documents.Messages.java file.
  Using the eclipse refactoring methods move all others Messages.java of the plugin into the this file,
  but leave an empty Messages.java which inherits from the <symbolic-name>.Messages, to minimize changes in the plugins
* The archie plugin has to be treated manually, as the translation is handled somehow differently
* Use the ruby scripts to populate missing french/italian translations via google translations
* the repository elexis-gpl will only be touched AFTER we merge Joerg sigles changes into 3.5
* Translations which are done via plugin*.properties and similar files, are done manually
* Verify manually the translation
** If possible use the Jubula GUI tests and examine all generated screenshots
** Create a dictionary with important translations for common concepts and place it into the elexis-3-core

## Possible problems

* Missing/superfluos translations are flagged when starting the application/loading a plugin, watch them
* Moving/Changing the Messages.java creates problems when merging changes from one branch to another

## List of Messages.java to be converted into new format

There are:

    elexis-3-base/at.medevit.elexis.cobasmira/src/at/medevit/elexis/cobasmira/ui/Messages.java
    elexis-3-base/ch.elexis.agenda/src/ch/elexis/agenda/series/ui/Messages.java
    elexis-3-base/ch.elexis.base.befunde/src/ch/elexis/base/befunde/Messages.java
    elexis-3-base/ch.elexis.base.ch.arzttarife/src/ch/elexis/tarmedprefs/Messages.java
    elexis-3-base/ch.elexis.connect.afinion/src/ch/elexis/connect/afinion/Messages.java
    elexis-3-base/ch.elexis.connect.afinion/src/ch/elexis/connect/afinion/packages/Messages.java
    elexis-3-base/ch.elexis.connect.afinion/src/ch/elexis/connect/afinion/packages/Messages.java 
    elexis-3-base/ch.elexis.connect.reflotron.v2/src/ch/elexis/connect/reflotron/Messages.java
    elexis-3-base/ch.elexis.connect.reflotron.v2/src/ch/elexis/connect/reflotron/packages/Messages.java
    elexis-3-base/ch.elexis.connect.sysmex/src/ch/elexis/connect/sysmex/Messages.java
    elexis-3-base/ch.elexis.connect.sysmex/src/ch/elexis/connect/sysmex/packages/Messages.java
    elexis-3-base/ch.elexis.laborimport.analytica/src/ch/elexis/laborimport/analytica/Messages.java
    elexis-3-base/ch.elexis.laborimport.teamw/src/ch/elexis/laborimport/teamw/Messages.java
    elexis-3-base/ch.medshare.commons/src/ch/medshare/util/Messages.java
    elexis-3-base/ch.medshare.commons/src/ch/medshare/util/Messages.java 
    elexis-3-base/ch.medshare.connect.abacusjunior/src/ch/medshare/connect/abacusjunior/Messages.java
    elexis-3-base/ch.medshare.connect.abacusjunior/src/ch/medshare/connect/abacusjunior/packages/Messages.java
    elexis-3-base/ch.medshare.elexis_directories/src/ch/medshare/elexis/directories/views/Messages.java
    elexis-3-base/ch.medshare.mediport/src/ch/medshare/mediport/gui/Messages.java
    elexis-3-base/ch.medshare.mediport/src/ch/medshare/mediport/Messages.java
    elexis-3-base/org.iatrix/src/org/iatrix/widgets/Messages.java
    elexis-3-core/ch.elexis.core.data/src/ch/elexis/data/Messages.java
    elexis-3-core/ch.elexis.core.documents/src/ch/elexis/core/documents/Messages.java
    elexis-3-core/ch.elexis.core.hl7.v2x/src/ch/elexis/hl7/v26/Messages.java
    elexis-3-core/ch.elexis.core.hl7.v2x/src/ch/elexis/hl7/v26/Messages.java 
    elexis-3-core/ch.elexis.core/src/ch/elexis/core/model/Messages.java
    elexis-3-core/ch.elexis.core/src/ch/elexis/core/model/Messages.java 
    elexis-3-core/ch.elexis.core.ui.contacts/src/ch/elexis/core/ui/contacts/views/Messages.java
    elexis-3-core/ch.rgw.utility/src/ch/rgw/io/Messages.java
    elexis-3-core/ch.rgw.utility/src/ch/rgw/io/Messages.java 
    elexis-3-core/ch.rgw.utility/src/ch/rgw/tools/Messages.java
    elexis-gpl/com.jsigle.noatext_jsl/src/ag/ion/bion/officelayer/internal/application/connection/Messages.java
    elexis-gpl/com.jsigle.noatext_jsl/src/ag/ion/bion/officelayer/internal/application/Messages.java
    elexis-gpl/com.jsigle.noatext_jsl/src/ag/ion/bion/officelayer/internal/document/Messages.java
    elexis-gpl/com.jsigle.noatext_jsl/src/ag/ion/bion/officelayer/internal/form/Messages.java
    elexis-gpl/com.jsigle.noatext_jsl/src/ag/ion/noa/Messages.java

### Good Example is ch.elexis.core.eigendiagnosen

Where your find the ch.elexis.core.eigendiagnosen.Message.java with the following content

    package ch.elexis.core.eigendiagnosen;

    import org.eclipse.osgi.util.NLS;

    public class Messages extends NLS {
        private static final String BUNDLE_NAME = "ch.elexis.core.eigendiagnosen.messages"; //$NON-NLS-1$
        public static String Eigendiagnosen_CodeSystemName;
        static {
            // initialize resource bundle
            NLS.initializeMessages(BUNDLE_NAME, Messages.class);
        }
        
        private Messages(){}
    }

    
### Backward compatibility

Existing Messages.java file which have not 

E.g is in bundle ch.elexis.core.ui.importer.div where we find the file ch.elexis.core.ui.importer.div.importers;.importers/Messages.java with the following content
    package ch.elexis.core.ui.importer.div.importers;

    /**
    * Ugly hack to provide a backward compatible implementation
    * @author Niklaus Giger
    *
    */
    public class Messages extends ch.elexis.core.ui.importer.div.Messages {
    }
    
This redirects everythin to ch.elexis.core.ui.importer.div.Messages.

## Working with trema database

The concerned files are:
    * Messages.java and messages*.properties which are the old source
    * A database elexis-translation my home directory, which is saved as a yaml file (for readability) and as a SQLlite3 databese (for SQL-queries)
    * Outputs as google_translation_cache.yaml/CSV  to be given to translaters (if a csv file exists, the yaml file will be ignored)
    * Texts.trm as the trema fil

To be able to use the google translation, the environment variable TRANSLATE_API_KEY must be defined

The workflow was the following

* Parse all the Messages.java and import them into the database ($HOME/elexis-translation.db) using

    ../elexis-3-core/ch.elexis.core.releng/i18n_gen_info.rb --parse-messsage bundles/

* Add missing translations, must be called for each language, eg, fr or it. Creates or updates $HOME/google_translation_cache.[csv|yaml]

    ../elexis-3-core/ch.elexis.core.releng/i18n_gen_info.rb --add-missing fr
      Initialized for 0 directories
      We want to translate 6758 items for de
      Translating Angegebener Kontakt nicht vorhanden found 1 was Angegebener Kontakt nicht vorhanden
      <...>
      Saving 7442 entries to /home/niklaus/google_translation_cache.yaml

* Generate a new trema file

      ../elexis-3-core/ch.elexis.core.releng/i18n_gen_info.rb --gen-trema
      Please report a bug if this causes problems.
      Initialized for 0 directories
      Generated /home/niklaus/trema.trm with 20381 nr_msgs

* Copy the updated trema.trm into the l10n directory, generate the properties, eg.

      cp /home/niklaus/trema.trm ./bundles/ch.elexis.base.l10n/rsc/texts.trm
      mvn clean process-sources
      git add ./bundles/ch.elexis.base.l10n

### Work to todo with i18n_gen_info.rb

* We should no longer generate a texts.trm for each plugin, only for the l10n project
* For this project we should emit only
* Instead of generating a plugin.trm we should directly generate the plugin_[lang].properties file
